#!/bin/bash
# 
# lwang: wrapper script to audit push, i.e., check the version.txt file
#
if [  "x$ITOPS_HOME" = "x" ]; then
  echo "You need to have environment variable ITOPS_HOME set: e.g., export ITOPS_HOME=~/code/itops"
  exit
fi

ssh=/bin/ssh

function usage() {

  echo " "
  echo "usage: $0 [-h] [-n] [-e <environment>] [ -w <war_file_name> ] [ <pool> ]"
  echo " "
  echo "where <pool> includes:"
  echo "  all "
  echo "  <specific pool name> "
  echo " "
  echo "If \"all\" is provided, all the pools will be checked."
  echo " "
  echo "-n is used for pretty printing: have app, machine, version info on one line"
  echo " "
  echo "e.g., $0 -e stg <pool>"
  echo " "
  echo "e.g., $0 -n -e stg <pool>"
  echo " "
  echo "e.g., $0 -n -e stg -w nmp-war nhome"
  echo "	: this is used when you have rolled back a FE component "
  echo " "
}


if [ $# = 0 ]; then
  usage
  exit 0
fi

ECHON=0
while getopts ":hne:w:" opt; do
  case $opt in
    h )
      usage
      exit 0
      ;;
    e )
      MYENV="$OPTARG"
      if [ "$ECHON" -ne 1 ]; then
        echo
        echo "Pools in environment: $MYENV: "
        POOLS=`${ITOPS_HOME}/bin/cmtool.pl -a get_pools -env ${MYENV} 2>/dev/null`
        echo
        echo $POOLS
        echo
        echo
      fi
      ;;
    w )
      war_file_name="$OPTARG"
      ;;
    n )
      ECHON=1
      ;;
    \? )
      echo "unknown option: $opt"
      exit 1
      ;;
  esac
done
shift $(($OPTIND -1))

echon() {
  echo "$*" | tr -d "\n"
}

function check_it() {
    p=$1

    # TODO:
    # handle people-search individually
    #
    if [ "$p" == "people-search" ]; then
      for inst in `$ITOPS_HOME/bin/cmtool.pl  -a get_ppsearch_instances -env $MYENV 2>/dev/null`; do
 

        for h in `$ITOPS_HOME/bin/cmtool.pl  -a  get_ppsearch_instance_hosts -env $MYENV -ppsearch_instance $inst 2>/dev/null`; do 
          if [ "$ECHON" -eq 1 ]; then
            echon  "$p  $h  $inst "
            echon ` $ssh cm@$h "if [ -e /export/content/glu/apps/$p ]; then echo 'GLU';  /bin/rm -rf META-INF; /bin/jar xf /export/content/glu/apps/${inst}/webapps/*.war  META-INF; chmod -R 777 META-INF; cat META-INF/MANIFEST.MF | grep 'Implementation-Version:' | cut -d\" \" -f2 ; else if [ -e /export/content/$inst/version.txt ]; then cat /export/content/$inst/version.txt; fi; fi " 2>/dev/null `
            echo
          else
            echo === Auditing $p on $h $inst
            $ssh cm@$h "if [ -e /export/content/glu/apps/$p ]; then echo 'GLU';  /bin/rm -rf META-INF; /bin/jar xf /export/content/glu/apps/${inst}/webapps/*.war META-INF; chmod -R 777 META-INF; cat META-INF/MANIFEST.MF | grep 'Implementation-Version:' | cut -d\" \" -f2; else if [ -e /export/content/$inst/version.txt ]; then cat /export/content/$inst/version.txt; fi; fi" 2>/dev/null
            echo

          fi
          
        done
      done
      exit
    fi


    # TODO:
    # handle liar-member-search individually
    #
    if [ "$p" == "liar-member-search" ]; then
      for inst in `$ITOPS_HOME/bin/cmtool.pl  -a get_liar_member_search_instances -env $MYENV 2>/dev/null`; do


        for h in `$ITOPS_HOME/bin/cmtool.pl  -a  get_liar_member_search_instance_hosts -env $MYENV -liar_member_search_instance $inst 2>/dev/null`; do

          if [ "$ECHON" -eq 1 ]; then
            echon  "$p  $h  $inst "
            echon ` $ssh cm@$h "if [ -e /export/content/glu/apps/$p ]; then echo 'GLU';  /bin/rm -rf META-INF; /bin/jar xf  /export/content/glu/apps/${inst}/webapps/*.war  META-INF; chmod -R 777 META-INF; cat META-INF/MANIFEST.MF | grep 'Implementation-Version:' | cut -d\" \" -f2 ; else if [ -e /export/content/$inst/version.txt ]; then cat /export/content/$inst/version.txt; fi; fi " 2>/dev/null `
            echo
          else
            echo === Auditing $p on $h $inst
            $ssh cm@$h "if [ -e /export/content/glu/apps/$p ]; then echo 'GLU';  /bin/rm -rf META-INF; /bin/jar xf /export/content/glu/apps/${inst}/webapps/*.war  META-INF; chmod -R 777 META-INF; cat META-INF/MANIFEST.MF | grep 'Implementation-Version:' | cut -d\" \" -f2; else if [ -e /export/content/$inst/version.txt ]; then cat /export/content/$inst/version.txt; fi; fi" 2>/dev/null
            echo

          fi
    
        done
      done
      exit
    fi



    for h in `${ITOPS_HOME}/bin//cmtool.pl -a get_pool_hosts -pool $p -env ${MYENV} 2>/dev/null`; do
      echo
#      if [ "$ECHON" -eq 1 ]; then
#        echon  "$p  $h  "
#      else 
#        echo === Auditing $p on $h
#      fi
# have to hard code this sucker here for webapp :(
# 
#  see: is_front_end_webapp
#
#
      ${ITOPS_HOME}/bin/is_front_end_webapp $p
      if [ $? == 1 ]; then

        #fe_app_dir=`cat ${ITOPS_HOME}/manif/container_mapping_${MYENV} | egrep "^$p	" | cut -f2`
        fe_app_dir=$p
        if [ "$ECHON" -eq 1 ]; then
          echon  "$p  $h  "
          if [ -n "$war_file_name" ]; then
            echon ` $ssh cm@$h " if [ -e /export/content/glu/apps/$fe_app_dir ]; then  echo 'GLU';  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/glu/apps/$fe_app_dir/i001/wars/$war_file_name.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2 ; else if [ -e /export/content/$fe_app_dir/i001/version.txt ]; then cat /export/content/$fe_app_dir/i001/version.txt ; else  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/$fe_app_dir/i001/war/$war_file_name.war  META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi ; fi  " 2>/dev/null `
          else
#            echon `$ssh cm@$h tail -1 /export/content/$fe_app_dir/${p}_version.txt 2>/dev/null`
###### HERE
#            echon ` $ssh cm@$h " if [ -e /export/content/glu/apps/$fe_app_dir ]; then  echo 'GLU';  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/glu/apps/$fe_app_dir/i001/wars/$p-war.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2 ; else if [ -e /export/content/$fe_app_dir/i001/version.txt ]; then cat /export/content/$fe_app_dir/i001/version.txt ; else  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/$fe_app_dir/i001/wars/$p-war.war  META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi ; fi  " 2>/dev/null `
            echon ` $ssh cm@$h " if [ -e /export/content/glu/apps/$fe_app_dir ]; then  echo 'GLU';  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/glu/apps/$fe_app_dir/i001/wars/*.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2 ; else if [ -e /export/content/$fe_app_dir/i001/version.txt ]; then cat /export/content/$fe_app_dir/i001/version.txt ; else  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/$fe_app_dir/i001/wars/*.war  META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi ; fi  " 2>/dev/null `
          fi
          echo
        else
          echo === Auditing $p on $h
          if [ -n "$war_file_name" ]; then
#            $ssh cm@$h "  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/$fe_app_dir/i001/webapps/$war_file_name.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2   " 2>/dev/null 

            echon ` $ssh cm@$h " if [ -e /export/content/glu/apps/$fe_app_dir ]; then  echo 'GLU';  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/glu/apps/$fe_app_dir/i001/wars/$war_file_name.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2 ; else if [ -e /export/content/$fe_app_dir/i001/version.txt ]; then cat /export/content/$fe_app_dir/i001/version.txt ; else  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/$fe_app_dir/i001/wars/$war_file_name.war  META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi ; fi  " 2>/dev/null `
          else
#            $ssh cm@$h tail -1 /export/content/$fe_app_dir/${p}_version.txt 2>/dev/null
            echon ` $ssh cm@$h " if [ -e /export/content/glu/apps/$fe_app_dir ]; then  echo 'GLU';  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/glu/apps/$fe_app_dir/i001/wars/*.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2 ; else if [ -e /export/content/$fe_app_dir/i001/version.txt ]; then cat /export/content/$fe_app_dir/i001/version.txt ; else  /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/$fe_app_dir/i001/wars/*.war  META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi ; fi  " 2>/dev/null `
          fi
          echo
        fi
 
        if [ $p == "captcha" ]; then
          
#            echon  "$p  $h  "
            echon ` $ssh cm@$h " /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf   /export/content/$p/i001/wars/$p.war  META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2   " 2>/dev/null `

          else 

#            echo === Auditing $p on $h 
            $ssh cm@$h " /bin/mkdir $p ; cd $p; /bin/rm -rf META-INF; /bin/jar xf    /export/content/$p/i001/wars/$p.war   META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2   " 2>/dev/null

        fi

      else 

        if [ "$p" == "people-search" ]; then
        ########################################################
        # this section is deprecated by the block above, phew!
        ########################################################
          if [ "$ECHON" -eq 1 ]; then
            #
            #
            # ugly hard-code for special case of ppl srch :(
            #
            #
            for instance in i001 i002 i003 i004 i005 i006 i007 i008 i009 i010 i011 i012 i013; do 

              if [ ! "X`$ssh cm@$h "ls -d /export/content/$p/$instance" 2>/dev/null`" == "X" ]; then
                echon  "$p  $h  $instance "
                echon ` $ssh cm@$h "if [ -e /export/content/glu/apps/$p ]; then echo 'GLU'; else if [ -e /export/content/$p/$instance/version.txt ]; then cat /export/content/$p/$instance/version.txt; else cd $HOME; /bin/rm -rf META-INF; /bin/jar xf  /export/content/$p/$instance/war/$p.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi; fi   " 2>/dev/null `;
                echo
              fi
            done
  #          echon ` $ssh cm@$h "if [ -e /export/content/$p/i001/version.txt ]; then cat /export/content/$p/i001/version.txt; else cd $HOME; /bin/rm -rf META-INF; /bin/jar xf  /export/content/$p/i001/war/$p.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi   " 2>/dev/null `
          else
            for instance in i001 i002 i003 i004 i005 i006 i007 i008 i009 i010 i011 i012 i013; do  
              if [ ! "X`$ssh cm@$h "ls -d /export/content/$p/$instance" 2>/dev/null`" == "X" ]; then
                echo === Auditing $p on $h $instance
                $ssh cm@$h "if [ -e /export/content/glu/apps/$p ]; then echo 'GLU'; else if [ -e /export/content/$p/$instance/version.txt ]; then cat /export/content/$p/$instance/version.txt; else cd $HOME;  /bin/rm -rf META-INF; /bin/jar xf  /export/content/$p/$instance/war/$p.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi; fi   " 2>/dev/null
  #              $ssh cm@$h "if [ -e /export/content/$p/i001/version.txt ]; then cat /export/content/$p/i001/version.txt; else cd $HOME;  /bin/rm -rf META-INF; /bin/jar xf  /export/content/$p/i001/war/$p.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi   " 2>/dev/null
                echo
              fi
            done
          fi

        else

          if [ "$ECHON" -eq 1 ]; then

            echon  "$p  $h  "
            echon ` $ssh cm@$h "if [ -e /export/content/glu/apps/$p ]; then echo 'GLU'; /bin/mkdir $p;  cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/glu/apps/$p/i00[1-9]/*/*.war   META-INF; chmod -R 777 META-INF; cat META-INF/config.properties | grep 'com.foobar.app.version=' | cut -d\"=\" -f2 ;   else if [ -e /export/content/$p/i001/version.txt ]; then cat /export/content/$p/i001/version.txt; else /bin/mkdir $p; cd $p;  /bin/rm -rf META-INF; /bin/jar xf  /export/content/$p/i001/war/$p-war.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi ; fi  " 2>/dev/null `

          else 

            echo === Auditing $p on $h 
            $ssh cm@$h "if [ -e /export/content/glu/apps/$p ]; then echo 'GLU'; /bin/mkdir $p; cd $p; /bin/rm -rf META-INF; /bin/jar xf  /export/content/glu/apps/$p/i00[1-9]/*/*.war   META-INF; chmod -R 777 META-INF; cat META-INF/config.properties | grep 'com.foobar.app.version=' | cut -d\"=\" -f2;   else if [ -e /export/content/$p/i001/version.txt ]; then cat /export/content/$p/i001/version.txt; else /bin/mkdir $p; cd $p;  /bin/rm -rf META-INF; /bin/jar xf   /export/content/$p/i001/webapps/$p-war.war META-INF/MANIFEST.MF; chmod -R 777 META-INF; cat  META-INF/MANIFEST.MF |grep 'Implementation-Version:' | cut -d\" \" -f2; fi;   fi   " 2>/dev/null

          fi
        fi
      fi
    done
    echo
}

function check_all() {
  for i in $POOLS; do
    check_it $i
  done

  exit 
}

if [ $# != 0 ]; then
  for i in "$@"; do
    if [ $i != 'all' ]; then
      check_it $i
    else
      check_all
    fi
  done
fi
