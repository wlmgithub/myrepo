#!/usr/bin/perl -w
use strict;

### globals
my $DATA_DIR="/Library/WebServer/Documents/dashboard/data/version_mismatch";

#
#  for i in `glulist -f prod-ech3 --container | sort -u  `; do echo; echo ======= $i;  push_auditor  -c $i --silent ;  done
#
#================================================================================
#Auditing result:  NOT OK
#================================================================================
#


my $glulist = "/usr/local/foobar/bin/glulist";
my $push_auditor = "/usr/local/foobar/bin/push_auditor";


print "working via GLU API, it takes about 20 minutes to complete ...\n";
my @all_services = get_all_services_in_ela4();

#print "@all_services\n";

# before we do anything, yank all files in DATA_DIR, no need to leave any dust
cleanup_data_dir();

for my $service ( @all_services ) {
  
  print "checking $service ...\n";

  chomp ( my $res = `$push_auditor -s $service | egrep 'Auditing result: '` );

# my @res_for_ech3 = `$push_auditor -f prod-ech3 -s $service`;
#  my @res_for_ela4 = `$push_auditor -f prod-ela4 -s $service`;

  my $stat; # OK | NOT OK
  if ( $res =~ m{^Auditing result:\s+(.*)} ) {
    $stat = $1;
  }

  ### only handle case where stat is 'NOT OK'
  if ( $stat eq 'NOT OK' ) {

    my $fname_ech3 = "$DATA_DIR/$service.ech3";
    my $fname_ela4 = "$DATA_DIR/$service.ela4";

    my @list_for_ech3 = `$push_auditor  -f prod-ech3 -s $service`  ;
    my @list_for_ela4 = `$push_auditor  -f prod-ela4 -s $service`  ;

    open my $fh_ech3, ">$fname_ech3" or die "cannot write to file: $fname_ech3: $!\n";
    print $fh_ech3 @list_for_ech3;
    close $fh_ech3;
    chmod 0777, $fname_ech3;

    open my $fh_ela4, ">$fname_ela4" or die "cannot write to file: $fname_ela4: $!\n";
    print $fh_ela4 @list_for_ela4;
    close $fh_ela4;
    chmod 0777, $fname_ela4;

  }

}

### subs

sub get_all_services_in_ela4 {

  chomp( my @s = `$glulist  -f prod-ela4` );

  return @s if wantarray;

}


sub cleanup_data_dir {

  opendir D, "$DATA_DIR";
  for my $file ( readdir(D) ) {
    next if  $file =~ /^\./;
    unlink "$DATA_DIR/$file";
  }
  closedir D;

}


